# ====================================================================================
# WORKFLOW SIMPLIFIÉ POUR LES APPLICATIONS ET ADD-ONS KUBERNETES
# Un seul job qui gère le déploiement ou la destruction complète.
# ====================================================================================
name: "APPS: Deploy or Destroy Kubernetes Apps & Add-ons"

on:
  # Déclenchement manuel pour les actions 'apply' ou 'destroy'
  workflow_dispatch:
    inputs:
      action:
        description: 'Action : "apply" pour déployer, "destroy" pour tout supprimer'
        required: true
        default: 'apply'
        type: choice
        options:
          - apply
          - destroy

jobs:
  # ===================================================================
  # JOB UNIQUE : Gère tout le cycle de vie des add-ons
  # ===================================================================
  manage-kubernetes-resources:
    name: "Deploy or Destroy Kubernetes Resources"
    
    # S'exécute sur votre runner qui a accès à tout
    runs-on: ["self-hosted", "aws-private-runner"]
    
    steps:
      # --- ÉTAPE 1 : PRÉPARATION COMMUNE ---
      - name: Checkout source code
        uses: actions/checkout@v4

      - name: Configure Kubeconfig for EKS
        run: |
          echo "Configuring kubectl to connect to EKS cluster 'tws-eks-cluster'..."
          aws eks update-kubeconfig --region us-east-1 --name tws-eks-cluster
          echo "Kubeconfig configured."

      # --- ÉTAPE 2 : LOGIQUE DE DESTRUCTION (s'exécute seulement si action=destroy) ---
      - name: "Cleanup: Delete 'quiz' namespace and wait"
        if: github.event.inputs.action == 'destroy'
        run: |
          echo "--- Deleting 'quiz' namespace to remove all its resources (Ingress, etc.)... ---"
          kubectl delete namespace quiz --ignore-not-found=true
          
          echo "IMPORTANT: Waiting 3 minutes for AWS to delete dependent resources (Load Balancers)..."
          sleep 180
          echo "Wait complete."

      # --- ÉTAPE 3 : LOGIQUE TERRAFORM (pour apply et destroy) ---
      - name: Terraform Init
        working-directory: ./terraform/apps
        run: terraform init

      - name: Terraform Plan
        working-directory: ./terraform/apps
        run: terraform plan -no-color -out=planfile

      - name: Terraform Apply (Deploy Add-ons)
        if: github.event.inputs.action == 'apply'
        working-directory: ./terraform/apps
        run: terraform apply -auto-approve -input=false planfile

      - name: Terraform Destroy (Remove Add-ons)
        if: github.event.inputs.action == 'destroy'
        working-directory: ./terraform/apps
        run: |
          echo "WARNING: Destroying all Helm-managed add-ons (ArgoCD, Prometheus, etc.)..."
          terraform destroy -auto-approve
