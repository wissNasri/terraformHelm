# Nom du fichier : .github/workflows/deploy-addons.yml
# VERSION FINALE ROBUSTE v2 : Neutralise l'app-of-apps en premier.

name: "APPS: Deploy or Destroy Kubernetes Add-ons"

on:
  push:
    branches: [main]
    paths: ['terraform/apps/**', '.github/workflows/deploy-addons.yml']
  pull_request:
    branches: [main]
    paths: ['terraform/apps/**', '.github/workflows/deploy-addons.yml']
  workflow_dispatch:
    inputs:
      action:
        description: 'Action: "apply" (déployer) ou "destroy" (détruire)'
        required: true
        default: 'apply'
        type: choice
        options: [apply, destroy]
      confirm_destroy:
        description: 'Si action=destroy, tapez "destroy-all-addons" pour confirmer.'
        required: false

jobs:
  # ===================================================================
  # JOB 1 : DÉPLOIEMENT (INCHANGÉ)
  # ===================================================================
  deploy-addons:
    name: "Terraform Apply for Add-ons"
    if: github.event.inputs.action == 'apply' || github.event_name == 'push'
    runs-on: ["self-hosted", "aws-private-runner"]
    defaults:
      run:
        shell: bash
        working-directory: ./terraform/apps
    steps:
      - name: Checkout source code
        uses: actions/checkout@v4
      - name: Configure Kubeconfig for EKS
        run: |
          aws eks update-kubeconfig --region us-east-1 --name tws-eks-cluster
          kubectl get nodes -o wide
      - name: Terraform Init
        run: terraform init
      - name: Terraform Apply (for workflow_dispatch)
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'apply'
        run: |
          echo "--- Running Terraform Apply: Step 1 (Core Add-ons) ---"
          terraform plan -no-color -out=plan-step1
          terraform apply -auto-approve -input=false plan-step1
          echo "--- Waiting 30 seconds for add-ons to stabilize ---"
          sleep 30
          echo "--- Running Terraform Apply: Step 2 (App-of-Apps) ---"
          terraform plan -no-color -out=plan-step2 -var="deploy_app_of_apps=true"
          terraform apply -auto-approve -input=false plan-step2
      - name: Validate Terraform Plan (on push to main)
        if: github.event_name == 'push'
        run: terraform plan -no-color

  # ===================================================================
  # JOB 2 : DESTRUCTION ORCHESTRÉE (LOGIQUE FINALE CORRIGÉE)
  # ===================================================================
  destroy-addons:
    name: "Orchestrated Destroy for Add-ons"
    if: |
      github.event_name == 'workflow_dispatch' &&
      github.event.inputs.action == 'destroy' &&
      github.event.inputs.confirm_destroy == 'destroy-all-addons'
    
    runs-on: ["self-hosted", "aws-private-runner"]
    defaults:
      run:
        shell: bash
        working-directory: ./terraform/apps

    steps:
      - name: Checkout source code
        uses: actions/checkout@v4
      - name: Configure Kubeconfig for EKS
        run: |
          aws eks update-kubeconfig --region us-east-1 --name tws-eks-cluster
          kubectl get nodes

      # --- ÉTAPE 1 : NEUTRALISATION DE LA SOURCE DE VÉRITÉ ARGO CD ---
      - name: "Pre-Destroy: Delete App-of-Apps Root to Stop Self-Healing"
        run: |
          echo "--- [START] Deleting app-of-apps-root to prevent recreation ---"
          # On supprime d'abord le parent pour arrêter le self-healing
          if kubectl get application app-of-apps-root -n argocd > /dev/null 2>&1; then
            echo "Patching app-of-apps-root to remove finalizer..."
            kubectl patch application app-of-apps-root -n argocd -p '{"metadata":{"finalizers":[]}}' --type=merge
            echo "Deleting app-of-apps-root..."
            kubectl delete application app-of-apps-root -n argocd --wait=false
          else
            echo "Application 'app-of-apps-root' not found, skipping."
          fi
          # On donne quelques secondes à Argo CD pour traiter la suppression
          sleep 10
          echo "--- [END] App-of-Apps root deleted. ---"

      # --- ÉTAPE 2 : NETTOYAGE DES APPLICATIONS ENFANTS ---
      - name: "Pre-Destroy: Clean Child Argo CD Applications"
        run: |
          echo "--- [START] Cleaning child applications (quiz-prod, quiz-staging) ---"
          for app in quiz-prod quiz-staging; do
            if kubectl get application $app -n argocd > /dev/null 2>&1; then
              echo "Patching application '$app' to remove finalizer..."
              kubectl patch application $app -n argocd -p '{"metadata":{"finalizers":[]}}' --type=merge
              echo "Deleting application '$app'..."
              # On ne met pas de --wait ici pour que ça s'exécute en parallèle du reste
              kubectl delete application $app -n argocd --wait=false
            else
              echo "Application '$app' not found, skipping."
            fi
          done
          echo "--- [END] Child applications deletion initiated. ---"

      # --- ÉTAPE 3 : DÉSINSTALLATION D'ELASTICSEARCH ---
      - name: "Pre-Destroy: Uninstall Elasticsearch Helm Chart"
        run: |
          echo "--- [START] Uninstalling Elasticsearch to release pods ---"
          helm uninstall elasticsearch -n logging --wait=false || echo "Elasticsearch chart not found or already uninstalled."
          echo "--- [END] Elasticsearch chart uninstallation initiated. ---"

      # --- ÉTAPE 4 : NETTOYAGE FINAL ET ATTENTE ---
      - name: "Pre-Destroy: Final Cleanup of PVCs and Pods"
        run: |
          echo "--- [START] Deleting all application PVCs and waiting for pods to terminate ---"
          # On attend un peu que les ordres de suppression des étapes précédentes soient pris en compte
          sleep 15
          
          for ns in quiz quiz-staging logging; do
            if kubectl get ns $ns > /dev/null 2>&1; then
              echo "Deleting PVCs in namespace '$ns'..."
              kubectl delete pvc --all -n $ns --ignore-not-found=true
            fi
          done
          
          echo "Waiting up to 5 minutes for pods in stateful namespaces to terminate..."
          for ns in quiz quiz-staging logging; do
             if kubectl get ns $ns > /dev/null 2>&1; then
                kubectl wait --for=delete pod --all -n $ns --timeout=5m --ignore-not-found=true || echo "Timeout or no pods found in $ns to wait for."
             fi
          done
          echo "--- [END] Final cleanup complete. ---"

      # --- ÉTAPE 5 : DESTRUCTION DE L'INFRASTRUCTURE ---
      - name: "Execute Terraform Destroy (DANGEROUS)"
        run: |
          echo "WARNING: All pre-destroy cleanup steps are done. Proceeding with 'terraform destroy'."
          terraform init
          terraform destroy -auto-approve -var="deploy_app_of_apps=true"
