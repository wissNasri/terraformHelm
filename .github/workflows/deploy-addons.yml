# ====================================================================================
# WORKFLOW POUR LES APPLICATIONS ET ADD-ONS KUBERNETES (Version Améliorée)
# Gère le cycle de vie complet, en ciblant spécifiquement les namespaces applicatifs.
# ====================================================================================
name: "APPS: Deploy, Destroy & Cleanup Kubernetes Apps/Add-ons"

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Action : "apply" pour déployer, "destroy" pour tout supprimer'
        required: true
        default: 'apply'
        type: choice
        options:
          - apply
          - destroy

jobs:
  # ===================================================================
  # JOB 1 : NETTOYAGE CIBLÉ DES APPLICATIONS KUBERNETES
  # S'exécute en premier, mais UNIQUEMENT pour l'action "destroy".
  # Supprime les namespaces des applications pour nettoyer toutes leurs ressources.
  # ===================================================================
  cleanup-app-namespaces:
    name: "1. Cleanup App Namespaces (quiz, etc.)"
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'destroy'
    
    runs-on: ["self-hosted", "aws-private-runner"]

    steps:
      # Étape 1.1 : Se connecter au cluster EKS
      - name: Configure Kubeconfig for EKS
        run: |
          echo "Configuring kubectl to connect to EKS cluster 'tws-eks-cluster'..."
          aws eks update-kubeconfig --region us-east-1 --name tws-eks-cluster
          echo "Kubeconfig configured successfully."

      # Étape 1.2 : Supprimer les namespaces applicatifs
      - name: Delete application namespaces to remove all their resources
        run: |
          echo "--- Deleting 'quiz' namespace to clean up all its resources (Ingress, Services, PVCs)... ---"
          kubectl delete namespace quiz --ignore-not-found=true
          
          # Ajoutez ici d'autres namespaces si vous en avez
          # echo "--- Deleting 'other-app' namespace... ---"
          # kubectl delete namespace other-app --ignore-not-found=true
          
          echo "Namespace deletion initiated. This is an asynchronous process."
          echo "Waiting 3 minutes for Kubernetes and AWS controllers to de-provision all resources (Load Balancers, EBS...)"
          sleep 180
          echo "Wait time complete. Proceeding to destroy Helm charts."

  # ===================================================================
  # JOB 2 : DÉPLOIEMENT OU DESTRUCTION DES ADD-ONS (HELM CHARTS)
  # Ce job reste identique.
  # ===================================================================
  manage-addons-via-terraform:
    name: "2. Terraform for Kubernetes Add-ons"
    needs: cleanup-app-namespaces
    if: always() && (github.event.inputs.action != 'destroy' || needs.cleanup-app-namespaces.result == 'success')
    
    runs-on: ["self-hosted", "aws-private-runner"]
    
    defaults:
      run:
        shell: bash
        working-directory: ./terraform/apps

    steps:
      - name: Checkout source code
        uses: actions/checkout@v4

      - name: Configure Kubeconfig for EKS
        run: aws eks update-kubeconfig --region us-east-1 --name tws-eks-cluster

      - name: Terraform Init
        run: terraform init

      - name: Terraform Plan
        run: terraform plan -no-color -out=planfile

      - name: Terraform Apply (Deploy Add-ons)
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'apply'
        run: terraform apply -auto-approve -input=false planfile

      - name: Terraform Destroy (Remove Add-ons)
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'destroy'
        run: terraform destroy -auto-approve
